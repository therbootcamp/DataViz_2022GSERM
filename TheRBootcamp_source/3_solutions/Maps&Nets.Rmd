---
title: "R Notebook"
output:
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

In this practical, you will create a map of Basel showing the distribution of wealth.   

# 0 - Preliminaries

1. If you haven't done so already, load the `tidyverse` and the `taxation.csv` data. 

```{r}
library(tidyverse)
basel <- read_csv('../1_data/taxation.csv')
```

2. Load the packages `sf`, `tidygraph`, and `ggraph`. 

```{r}
library(sf)
library(tidygraph)
library(ggraph)
```

# 1 - Loading shapefiles

1. Use `read_sf` to read in all of the shape files contained in the `quarters` folder and save the result as `basel_map`. The function will automatically read all files contained in the folder.

```{r}
basel_map <- read_sf("../1_data/quarters")
```

2. Print `basel_map` in the console and try to make sense of its contents. 

# 2 - Plotting a map

1. Now, put Basel's quarters on the map. Pipe the `basel_map` object into an otherwise empty `ggplot()` function and add `geom_sf()`. 

```{r}
basel_map %>% 
  ggplot() + 
  geom_sf()
```

2. Since we are not really interested in coordinates, remove the background by adding `theme_void()`.  

```{r}
basel_map %>% 
  ggplot() + 
  geom_sf() + 
  theme_void()
```

3. If you like, you could already start styling the map, e.g., by coloring the borders and areas. To do this, set, for instance, `col = "white"` and `fill = "blue"`. But the question is where? Try first making these settings inside `ggplot(aes())`. 

```{r}
basel_map %>% 
  ggplot(aes(col = "white", fill = "blue")) + 
  geom_sf() + 
  theme_void()
```

4. That didn't work. The problem is that anything inside of `aes()` is interpreted as a variable, not as constant. Now make these settings inside of `geom_sf()` without using the `aes()` helper function. That's how we usually set aesthetics to constants: inside of the geom, outside of `aes()`.

```{r}
basel_map %>% 
  ggplot() + 
  geom_sf(col = "white", fill = "blue") + 
  theme_void()
```

# 3 - Adding variables

1. You know already how to create a map. Now, we shall see how we can add variables, such as income and wealth , and represent them in our map. To add the variables in our `basel` object, simply `join` it to the `basel_map` object by matching `"TYPE"` and `"qaurter"`. This is possible because `basel_map` is also a `tibble`. Save the result back to `basel_map`.

```{r}
basel_map <- basel_map %>% 
  left_join(basel,
            by = c("TYPE" = "quarter"))
```

2. Now that our taxation data has been added to `basel_map`, you can start representing the data in the map. How about instead of `fill = "blue"` you fill the areas according to `wealth_mean`. Since `wealth_mean` is a variable, place it into `aes()`. You can do this either inside `ggplot()` or `geom_sf()`. Note that if you forget to delete `fill = "blue"` nothing will happen, as setting `fill` to a constant will overwrite the settings made in `aes()`.    

```{r}
basel_map %>% 
  ggplot(aes(fill = wealth_mean)) + 
  geom_sf(col = "white") + 
  theme_void()
```

# 4 - Styling

1. Add appropriate labels using `labs()`. 

```{r}
basel_map %>% 
  ggplot(aes(fill = wealth_mean)) + 
  geom_sf(col = "white") + 
  theme_void() + 
  labs(title = "Inequality in Basel",
       subtitle = "Wealth mean distribution across Basel's quarters in 2017")
```


2. Fix the legend title by adding, e.g., `scale_fill_continuous(name = 'Wealth')`.

```{r}
basel_map %>% 
  ggplot(aes(fill = wealth_mean)) + 
  geom_sf(col = "white") + 
  theme_void() + 
  labs(title = "Inequality in Basel",
       subtitle = "Wealth mean distribution across Basel's quarters in 2017") +
  scale_fill_continuous(name = 'Wealth')
```

# 5 - Networks

1. The first step to creating a network involves obtaining relational data. In this example, you will analyze the relatedness in the development of wealth between quarters. Use the code below to create a matrix of correlations that reflect the pairwise relatednes in wealth development. 

```{r}
edges <- basel %>% 
  select(year, quarter, income_median) %>% 
  pivot_wider(names_from = quarter, values_from = income_median) %>% 
  select(-1) %>% 
  cor() %>% 
  as.table() %>% 
  as_tibble(.name_repair = "unique") %>% 
  rename(from = `...1`,
         to = `...2`,
         weight = n) %>% 
  filter(weight<1, weight < -.5)
```

2. Next, use the `as_tbl_graph()` function from the `tidygraph` package to create a network of the relational data. Set the argument `directed` to `FALSE`, since the correlations do no reflect a directed relatedness between the quarters. 

```{r}
network <- as_tbl_graph(XX, XX = XX)
```

3. Use now the `ggraph()` function from the `ggraph` package to start a blank network plot. The function needs to arguments

```{r}
network %>% 
  XX
```

4. Add 

```{r}
network %>% 
  XX
```



# 5 - Go explore

1. https://www.diva-gis.org/datadown





